<div class="filters">
  <label for="region-select">Выберите регион:</label>
  <select id="region-select">
    <option value="все">Все регионы</option>
    {% for region in allRegions %}
      <option value="{{ region | escape }}">{{ region | escape }}</option>
    {% endfor %}
  </select>

  <label for="category-select">Выберите категорию:</label>
  <select id="category-select">
    <option value="все">Все категории</option>
    {% for category in allCategories %}
      <option value="{{ category | escape }}">{{ category | escape }}</option>
    {% endfor %}
  </select>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const profileList = document.getElementById('profile-list');
    const regionSelect = document.getElementById('region-select');
    const categorySelect = document.getElementById('category-select');
    const profiles = profileList.querySelectorAll('.profile-card');

    // Нормализация строк: удаляем пробелы и приводим к нижнему регистру
    const normalizeString = (str) => (str || '').trim().toLowerCase();

    // Сохраняем исходные профили для фильтрации
    const allProfiles = Array.from(profiles).map(profile => ({
      city: normalizeString(profile.dataset.region),
      category: normalizeString(profile.dataset.category),
      innerHTML: profile.outerHTML
    }));

    console.log('All profiles:', allProfiles);

    function filterProfiles() {
      const region = normalizeString(regionSelect.value);
      const category = normalizeString(categorySelect.value);

      console.log('Filtering with region:', region, 'category:', category);

      profileList.innerHTML = '';

      const filtered = allProfiles.filter(p => {
        const matchRegion = region === 'все' || p.city === region;
        const matchCategory = category === 'все' || p.category === category;
        return matchRegion && matchCategory;
      });

      console.log('Filtered profiles:', filtered);

      if (filtered.length === 0) {
        profileList.innerHTML = '<p>Профили не найдены.</p>';
        return;
      }

      filtered.forEach(p => {
        profileList.insertAdjacentHTML('beforeend', p.innerHTML);
      });
    }

    // Проверка, существуют ли элементы
    if (!regionSelect || !categorySelect) {
      console.error('Select elements not found');
      return;
    }

    regionSelect.addEventListener('change', () => {
      console.log('Region select changed');
      filterProfiles();
    });
    categorySelect.addEventListener('change', () => {
      console.log('Category select changed');
      filterProfiles();
    });

    // Первоначальная фильтрация (на случай, если выбраны значения по умолчанию)
    filterProfiles();
  });
</script>