<div class="filters">
  <label for="region-select">Выберите регион:</label>
  <select id="region-select">
    <option value="все">Все регионы</option>
    {% for region in allRegions %}
      <option value="{{ region | escape | downcase }}">{{ region | escape }}</option>
    {% endfor %}
  </select>

  <label for="category-select">Выберите категорию:</label>
  <select id="category-select">
    <option value="все">Все категории</option>
    {% for category in allCategories %}
      <option value="{{ category | escape | downcase }}">{{ category | escape }}</option>
    {% endfor %}
  </select>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const profileList = document.getElementById('profile-list');
    const regionSelect = document.getElementById('region-select');
    const categorySelect = document.getElementById('category-select');
    const profiles = profileList.querySelectorAll('.profile-card');

    // Нормализация строк
    const normalizeString = (str) => {
      if (!str) return '';
      return str.trim().toLowerCase().replace(/\s+/g, ' ');
    };

    // Формируем HTML для профиля
    const createProfileCard = (profile) => {
      const safeName = profile.name ? profile.name.replace(/</g, '&lt;').replace(/>/g, '&gt;') : 'Без имени';
      return `
        <div class="profile-card" data-region="${normalizeString(profile.city)}" data-category="${normalizeString(profile.category)}">
          <img
            class="profile-card__image"
            width="300"
            height="200"
            src="${profile.image_url || '/img/placeholder.webp'}"
            alt="Фото профиля ${safeName}"
            loading="lazy"
          />
          <div class="profile-card__description">
            <h3>${safeName}</h3>
            <p>${profile.city || 'Регион не указан'}, ${profile.category || 'Категория не указана'}</p>
            ${profile.description ? `<p>${profile.description.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>` : ''}
            ${profile.age ? `<p>Возраст: ${profile.age}</p>` : ''}
            ${profile.email ? `<p>Email: <a href="mailto:${profile.email}">${profile.email}</a></p>` : ''}
            ${profile.phone ? `<p>Телефон: <a href="tel:${profile.phone}">${profile.phone}</a></p>` : ''}
            <a href="/profiles/${profile.id ? profile.id.replace(/[^a-z0-9-]/g, '-') : ''}/" aria-label="Подробнее о ${safeName}">Подробнее</a>
          </div>
        </div>
      `;
    };

    // Инициализация профилей
    let allProfiles = Array.from(profiles).map(profile => ({
      city: normalizeString(profile.dataset.region),
      category: normalizeString(profile.dataset.category),
      innerHTML: profile.outerHTML
    }));

    // Проверяем новый профиль в localStorage
    const newProfile = localStorage.getItem('newProfile');
    if (newProfile) {
      const profileData = JSON.parse(newProfile);
      console.log('New profile from localStorage:', profileData);
      allProfiles.unshift({
        city: normalizeString(profileData.city),
        category: normalizeString(profileData.category),
        innerHTML: createProfileCard(profileData)
      });
      localStorage.removeItem('newProfile');
    }

    console.log('All profiles:', allProfiles.map(p => ({ city: p.city, category: p.category })));
    console.log('Region options:', Array.from(regionSelect.options).map(opt => opt.value));
    console.log('Category options:', Array.from(categorySelect.options).map(opt => opt.value));

    function filterProfiles() {
      const region = normalizeString(regionSelect.value);
      const category = normalizeString(categorySelect.value);

      console.log('Filtering with region:', region, 'category:', category);

      profileList.innerHTML = '';

      const filtered = allProfiles.filter(p => {
        console.log('Checking profile:', { city: p.city, category: p.category, matchesRegion: region === 'все' || p.city === region, matchesCategory: category === 'все' || p.category === category });
        const matchRegion = region === 'все' || p.city === region;
        const matchCategory = category === 'все' || p.category === category;
        return matchRegion && matchCategory;
      });

      console.log('Filtered profiles:', filtered.map(p => ({ city: p.city, category: p.category })));

      if (filtered.length === 0) {
        profileList.innerHTML = '<p>Профили не найдены.</p>';
        return;
      }

      filtered.forEach(p => {
        profileList.insertAdjacentHTML('beforeend', p.innerHTML);
      });
    }

    if (!regionSelect || !categorySelect) {
      console.error('Select elements not found');
      return;
    }

    regionSelect.addEventListener('change', () => {
      console.log('Region select changed to:', regionSelect.value);
      filterProfiles();
    });
    categorySelect.addEventListener('change', () => {
      console.log('Category select changed to:', categorySelect.value);
      filterProfiles();
    });

    console.log('Event listeners attached:', regionSelect.onchange, categorySelect.onchange);

    filterProfiles();
  });
</script>