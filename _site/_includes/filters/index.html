<div class="filters">
  <label for="region-select">Выберите регион:</label>
  <select id="region-select">
    <option value="все">Все регионы</option>
  </select>

  <label for="category-select">Выберите категорию:</label>
  <select id="category-select">
    <option value="все">Все категории</option>
  </select>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const SUPABASE_URL = "https://zftnzsbflzfhfyfnyqza.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpmdG56c2JmbHpmaGZ5Zm55cXphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwODQyMjQsImV4cCI6MjA3MjY2MDIyNH0.ZiNtVmNKFPsW7NPngNvRrDsRFwcPQw0aE6m8FwmCvZg";


if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
  document.getElementById("profile-list").innerHTML = "<p>Ошибка: ключи Supabase не заданы</p>";
  throw new Error("SUPABASE_URL или SUPABASE_ANON_KEY отсутствуют");
}

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const profileList = document.getElementById("profile-list");
const regionSelect = document.getElementById("region-select");
const categorySelect = document.getElementById("category-select");

let allProfiles = [];

async function fetchProfiles() {
  const { data, error } = await supabase
    .from("profiles")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) {
    profileList.innerHTML = `<p>Ошибка загрузки профилей: ${error.message}</p>`;
    return;
  }

  allProfiles = data;
  renderProfiles(allProfiles);
  populateFilters(allProfiles);
}

function renderProfiles(profiles) {
  profileList.innerHTML = "";

  if (!profiles.length) {
    profileList.innerHTML = "<p>Профили не найдены.</p>";
    return;
  }

  profiles.forEach((p) => {
    const div = document.createElement("div");
    div.className = "profile-card";
    div.dataset.region = p.city || "";
    div.dataset.category = p.category || "";
    div.innerHTML = `
      <img
        class="profile-card__image"
        width="300"
        height="200"
        src="${p.image_url || '/img/placeholder.png'}"
        alt="Фото профиля ${p.name}"
      />
      <div class="profile-card__description">
        <h3>${p.name}</h3>
        <p>${p.city || ""}, ${p.category || ""}</p>
        <a href="/profiles/${p.id}/">Подробнее</a>
      </div>
    `;
    profileList.appendChild(div);
  });
}

function populateFilters(profiles) {
  const regions = [...new Set(profiles.map(p => p.city).filter(Boolean))];
  const categories = [...new Set(profiles.map(p => p.category).filter(Boolean))];

  regions.forEach(r => {
    if (![...regionSelect.options].some(opt => opt.value === r)) {
      const option = document.createElement("option");
      option.value = r;
      option.textContent = r;
      regionSelect.appendChild(option);
    }
  });

  categories.forEach(c => {
    if (![...categorySelect.options].some(opt => opt.value === c)) {
      const option = document.createElement("option");
      option.value = c;
      option.textContent = c;
      categorySelect.appendChild(option);
    }
  });
}

function filterProfiles() {
  const region = regionSelect.value;
  const category = categorySelect.value;

  const filtered = allProfiles.filter(p => {
    const matchRegion = region === "все" || p.city === region;
    const matchCategory = category === "все" || p.category === category;
    return matchRegion && matchCategory;
  });

  renderProfiles(filtered);
}

regionSelect.addEventListener("change", filterProfiles);
categorySelect.addEventListener("change", filterProfiles);

fetchProfiles();
</script>
